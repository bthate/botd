#!/usr/bin/python3
# BOTD - python3 IRC channel daemon.
#
# run unittests.

__version__ = 1

import os, sys ; sys.path.insert(0, os.getcwd())

import bl
import logging
import shutil
import time
import unittest

from bl import Object
from bl.krn import Kernel
from bl.log import level
from bl.shl import parse_cli
from bl.tms import elapsed
from bl.trc import get_exception
from bl.trm import save, reset
from bl.typ import get_cls
from bl.usr import Users
from bl.utl import cdir


opts = [
    ('-d', '--datadir', 'store', str, 'set working directory.', 'workdir'),
    ('-m', '--modules', 'store', str, 'modules to load.', 'modules'),
    ('-o', '--options', "store", str, "options to use.", 'options'),
    ('-l', '--loglevel', 'store', str, 'set loglevel.', 'level'),
    ('-v', '--verbose', 'store_true', False, 'enable verbose mode.', 'verbose')
]


k = Kernel()
users = Users()

def initialize(cfg):
    cdir("testdata")
    users.oper("test@shell")
    k.cfg.prompt = False
    k.walk("botd")
    k.start(cfg)
    for c in bl.tbl.classes:
        try:
            o = get_cls(c)()
            o.txt = "yo!"
            o.save()
        except (AttributeError, TypeError) as ex:
            pass

def execute(main):
    save()
    try:
        main()
    except KeyboardInterrupt:
        print("")
    except Exception:
        logging.error(get_exception())
    reset()

def main():
    try:
        shutil.rmtree("testdata")
    except:
        pass
    cfg = parse_cli("test", __version__, opts)
    bl.workdir = "testdata"
    level("debug")
    initialize(cfg)
    k.cfg.exclude = "mdl,rss"
    k.cfg.debug = True
    level(k.cfg.level)
    test_path = os.getcwd() + os.sep + "tests"
    p = ""
    if k.cfg.args:
        p = "test_%s*" % k.cfg.args[0]
    if not p:
        p = "test_*"
    suite = unittest.loader.TestLoader().discover(test_path, pattern=p)
    unittest.TextTestRunner(verbosity=3).run(suite)
   
execute(main)
print(elapsed(time.time() - bl.starttime))
os._exit(0)
