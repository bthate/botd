#!/usr/bin/python3 -u
# BOTD - python3 IRC channel daemon.
#
# 

__version__ = 1

import os, sys ; sys.path.insert(0, os.getcwd())

import grp
import os
import logging
import pwd
import sys
import bl.krn
import bl.tbl

from bl.csl import Console
from bl.err import EINIT
from bl.krn import Kernel, workdir
from bl.log import level, logfiled
from bl.shl import close_history, enable_history, execute, parse_cli, set_completer
from bl.trm import reset, save
from bl.trc import get_exception
from bl.utl import hd

opts = [
    ('-d', '--datadir', 'store', str, 'set working directory.', 'workdir'),
    ('-m', '--modules', 'store', str, 'modules to load.', 'modules'),
    ('-o', '--options', "store", str, "options to use.", 'options'),
    ('-l', '--loglevel', 'store', str, 'set loglevel.', 'level'),
    ('-a', '--logdir', "store", str, "directory to find the logfiles.", 'logdir'),
]

def daemon():
    pid = os.fork()
    if pid != 0:
        reset()
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", 'r')
    so = open("/dev/null", 'a+')
    se = open("/dev/null", 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())

def main():
    cfg = parse_cli("botd", __version__, opts, wd="/var/lib/botd")
    cfg.kernel = True
    level("debug")
    logging.warning("%s started at %s (%s)" % (cfg.name.upper(), cfg.workdir, cfg.level))
    daemon()
    k = Kernel(cfg)
    k.start()
    k.wait()

try:
    execute(main)
except PermissionError:
    print("you need to run botd as root")

os._exit(0)
